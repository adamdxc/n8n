name: Deploy n8n workflow to local K8s

on:
  workflow_dispatch:   # manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted   # ðŸ‘ˆ ensure your runner is running locally
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug cluster
        shell: pwsh
        run: |
          kubectl config current-context
          kubectl get nodes
          kubectl get pods -n default

      - name: Import workflow into n8n
        shell: pwsh
        run: |
          # 1. Download yaml.json to runner
          Invoke-WebRequest https://raw.githubusercontent.com/adamdxc/n8n/refs/heads/main/yaml.json -OutFile yaml.json

          # 2. Get n8n pod name
          $N8N_POD = kubectl get pod -n default -l app=n8n -o jsonpath="{.items[0].metadata.name}"
          Write-Output "Target pod: $N8N_POD"

          # 3. Copy workflow into pod
          kubectl cp yaml.json default/${N8N_POD}:/tmp/yaml.json

          # 4. Import workflow inside pod
          kubectl exec -i -n default ${N8N_POD} -- n8n import:workflow --input=/tmp/yaml.json --overwrite
