name: Deploy n8n to local K8s

on:
  workflow_dispatch:   # manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted   # ðŸ‘ˆ make sure this matches your local runner
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Debug kubectl
        run: |
          kubectl config current-context
          kubectl get nodes
          kubectl get pods -n default

      - name: Import workflow into n8n
        run: |
          $N8N_POD = kubectl get pod -n default -l app=n8n -o jsonpath="{.items[0].metadata.name}"
          kubectl exec -i -n default $N8N_POD -- sh -c "curl -sL https://raw.githubusercontent.com/adamdxc/n8n/refs/heads/main/yaml.json -o /tmp/yaml.json && n8n import:workflow --input=/tmp/yaml.json --overwrite"