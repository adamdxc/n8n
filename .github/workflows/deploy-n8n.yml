name: Deploy n8n Workflows

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download and patch yaml.json
        shell: pwsh
        run: |
          $url = "https://raw.githubusercontent.com/adamdxc/n8n/refs/heads/main/yaml.json"
          $json = Invoke-RestMethod -Uri $url

          if ($json -is [System.Collections.IEnumerable] -and $json -isnot [string]) {
            $json = $json | ForEach-Object { $_ | Add-Member -NotePropertyName active -NotePropertyValue $false -Force; $_ }
          } else {
            $json | Add-Member -NotePropertyName active -NotePropertyValue $false -Force
          }

          $json | ConvertTo-Json -Depth 100 | Out-File -FilePath yaml.json -Encoding utf8

      - name: Get n8n pod name
        shell: pwsh
        run: |
          $N8N_POD = kubectl get pod -n default -l app=n8n -o jsonpath="{.items[0].metadata.name}"
          echo "N8N_POD=$N8N_POD" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Copy workflow into pod
        shell: pwsh
        run: |
          kubectl cp yaml.json default/${env:N8N_POD}:/tmp/yaml.json

      - name: Import workflow into n8n
        shell: pwsh
        run: |
          kubectl exec -i -n default ${env:N8N_POD} -- n8n import:workflow --input=/tmp/yaml.json --overwrite
